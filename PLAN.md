# Оновлений План Покращення Конвертера та Інтеграції з Google Drive

**Мета:** Створити експериментальну версію додатку для перекладу та конвертації PDF у Google Docs з покращеною якістю форматування. Додаток буде інтегрований з Google Drive для вибору файлів та збереження результатів у визначену папку.

**Автентифікація:** Доступ до додатку буде контролюватися через Google Cloud Identity-Aware Proxy (IAP). Бекенд буде отримувати ідентифікаційні дані користувача з заголовків, які додає IAP.

---

### Етап 1: Модифікація Бекенду для Інтеграції з Google API

**Завдання:** Інтегрувати Google Docs та Google Drive API, а також покращити логіку обробки структури документа.

1.  **Додати залежності:** Оновити `requirements.txt`, додавши бібліотеки для роботи з Google API та парсингу Markdown:
    ```
    google-api-python-client
    google-auth-httplib2
    google-auth-oauthlib
    markdown-it-py[plugins] 
    ```
    *`markdown-it-py` буде використана для надійного парсингу Markdown-таблиць.*

2.  **Створити новий endpoint `/api/create_google_doc`:**
    *   **Призначення:** Прийматиме фінальний структурований JSON від фронтенду та створюватиме на його основі Google Doc.
    *   **Автентифікація:** Буде використовувати облікові дані сервісного акаунта, доступні в середовищі Cloud Run, для доступу до Google API.
    *   **Логіка створення документа:**
        *   Створити порожній Google Doc у визначеній папці на Google Drive (ID папки буде конфігурацією).
        *   **Обробка таблиць:** Використовувати `markdown-it-py` для перетворення Markdown-таблиць з JSON у структури даних Python.
        *   **Формування запиту:** Сформувати `batchUpdate` запит до Google Docs API. Кожен елемент (заголовок, параграф, рядок таблиці) буде окремим запитом у batch-і. Це забезпечить правильне створення нативних елементів Google Docs.
        *   **Вставка фонового зображення:** Для кожної сторінки вставляти растеризоване зображення з оригінального PDF як фонове зображення секції. Це дозволить візуально порівнювати якість розпізнавання.
    *   **Результат:** Endpoint повертатиме URL створеного Google Doc.

3.  **Створити endpoint `/api/process_drive_file`:**
    *   **Призначення:** Обробляти файли, вибрані користувачем з Google Drive.
    *   **Логіка:** Прийматиме `fileId` вибраного файлу. За допомогою Drive API (з обліковими даними сервісного акаунта) завантажуватиме файл і передаватиме його в існуючу логіку обробки PDF (`process_and_stream_pdf`).

---

### Етап 2: Модифікація Фронтенду для Роботи з Google Drive

**Завдання:** Інтегрувати Google Picker API для вибору файлів та оновити UI/UX для роботи з Google Docs.

1.  **Видалити зайві бібліотеки:** З `package.json` видалити `docx` та `file-saver`.

2.  **Оновити UI в `App.tsx`:**
    *   Замінити кнопки "Download DOCX" на єдину кнопку **"Створити Google Doc"**.
    *   Додати кнопку **"Вибрати файл з Google Drive"** поруч із поточною кнопкою завантаження.
    *   Прибрати опції форматування (шрифт, розмір), оскільки вони будуть визначатися стилями Google Docs.

3.  **Інтегрувати Google Picker API:**
    *   **Налаштування:** В `index.html` додати скрипт для завантаження Google API клієнта. Налаштувати OAuth 2.0 Client ID для веб-додатку в Google Cloud Console.
    *   **Логіка вибору файлу:**
        *   При натисканні на "Вибрати файл з Google Drive", ініціалізувати Picker.
        *   **Ключова вимога:** Налаштувати Picker так, щоб він відкривав **тільки визначену папку** на вашому Google Drive, обмежуючи вибір для користувачів. ID цієї папки буде конфігурацією.
        *   Після вибору файлу, отримати його `fileId` і відправити на бекенд (`/api/process_drive_file`) для обробки.

4.  **Оновити логіку створення документа:**
    *   Після завершення обробки файлу (незалежно від джерела), при натисканні на "Створити Google Doc", фронтенд відправляє фінальний JSON на `/api/create_google_doc`.
    *   Після отримання URL у відповіді, відкривати його в новій вкладці.

5.  **Прибрати застарілий код:** Видалити файл `services/docx.ts` та пов'язані з ним виклики.

---

### Етап 3: Розгортання та Тестування

1.  **Деплой:** Запустити `gcloud builds submit`, щоб розгорнути оновлену версію на експериментальному сервісі `pdf-converter-experimental`.
2.  **Тестування:**
    *   Протестувати обидва сценарії: завантаження локального файлу та вибір файлу з Google Drive.
    *   Особливу увагу приділити тестуванню PDF з великими та складними таблицями.
    *   Перевірити, що згенерований Google Doc коректно відображає таблиці та інше форматування.
    *   Перевірити, що фонові зображення сторінок вставлені коректно.

---
### Майбутні Покращення (Post-MVP)

*   **Пост-обробка в Google Docs:** Створити Google Apps Script, який може бути запущений на згенерованому документі для додаткового покращення форматування (наприклад, об'єднання клітинок, стилізація).
*   **Логування:** Впровадити логування `diff` між вхідним Markdown та результатом в Google Docs для аналізу та налагодження складних випадків.

**Наступний крок:** Я вже додав необхідні бібліотеки до `requirements.txt` у попередньому кроці, але операцію було скасовано. Я повторюю цю дію.